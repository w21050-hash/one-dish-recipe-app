<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¸€å“ææ¡ˆå‹ãƒ¬ã‚·ãƒ”è¨˜éŒ²ã‚¢ãƒ—ãƒªï¼ˆæ¥½å¤©ãƒ¬ã‚·ãƒ”å¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* === å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ === */
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 15px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 1.1rem;
      border-left: 6px solid #4CAF50;
      padding-left: 8px;
      margin-top: 24px;
      margin-bottom: 10px;
      color: #333;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      background-color: #45a049;
    }

    /* === ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ === */
    .recipe-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-top: 15px;
      transition: transform 0.2s;
    }

    .recipe-card:hover {
      transform: scale(1.01);
    }

    .recipe-card img {
      width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }

    /* === ã‚¹ãƒãƒ›å¯¾å¿œ === */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 1.3rem;
      }

      h2 {
        font-size: 1rem;
      }

      button {
        font-size: 15px;
        padding: 10px;
      }
    }
  </style>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDNrRl_pHrI3qNs0CysOb4UcRmfcFVPiCE",
    authDomain: "one-dish-recipe-app.firebaseapp.com",
    projectId: "one-dish-recipe-app",
    storageBucket: "one-dish-recipe-app.firebasestorage.app",
    messagingSenderId: "685959274245",
    appId: "1:685959274245:web:6c7194f9993c67aa9c216c"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const APP_ID = "1009563489332319367";
  let currentRecipe = null;

  // âœ… æ¥½å¤©ãƒ¬ã‚·ãƒ”å–å¾—
  async function getRakutenRecipe(ingredient) {
    const resultDiv = document.getElementById("recipeResult");
    resultDiv.innerHTML = "ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢ä¸­...";

    try {
      const catRes = await fetch(`https://app.rakuten.co.jp/services/api/Recipe/CategoryList/20170426?applicationId=${APP_ID}`);
      const catData = await catRes.json();

      const categories = [
        ...catData.result.large,
        ...catData.result.medium,
        ...catData.result.small
      ];

      const matched = categories.find(cat => cat.categoryName.includes(ingredient));
      if (!matched) {
        resultDiv.innerHTML = "è©²å½“ã™ã‚‹ãƒ¬ã‚·ãƒ”ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
      }

      const rankRes = await fetch(
        `https://app.rakuten.co.jp/services/api/Recipe/CategoryRanking/20170426?applicationId=${APP_ID}&categoryId=${matched.categoryId}`
      );
      const rankData = await rankRes.json();
      if (!rankData.result || rankData.result.length === 0) {
        resultDiv.innerHTML = "ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      const recipe = rankData.result[Math.floor(Math.random() * rankData.result.length)];
      currentRecipe = {
        ingredient,
        name: recipe.recipeTitle,
        image: recipe.foodImageUrl,
        url: recipe.recipeUrl,
        date: new Date().toISOString()
      };

      resultDiv.innerHTML = `
        <div class="recipe-card">
          <h3>${recipe.recipeTitle}</h3>
          <img src="${recipe.foodImageUrl}">
          <p><a href="${recipe.recipeUrl}" target="_blank">ãƒ¬ã‚·ãƒ”ã‚’é–‹ãï¼ˆæ¥½å¤©ãƒ¬ã‚·ãƒ”ï¼‰</a></p>
          <h4>æ„Ÿæƒ³ã‚’è¨˜éŒ²ã™ã‚‹</h4>
          <textarea id="recipeComment" placeholder="ä½œã£ã¦ã¿ãŸæ„Ÿæƒ³"></textarea>
          <label>è©•ä¾¡ï¼š
            <select id="recipeRating">
              <option value="5">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</option>
              <option value="4">â­ï¸â­ï¸â­ï¸â­ï¸</option>
              <option value="3">â­ï¸â­ï¸â­ï¸</option>
              <option value="2">â­ï¸â­ï¸</option>
              <option value="1">â­ï¸</option>
            </select>
          </label>
          <button onclick="saveRecipe()">æ„Ÿæƒ³ã¤ãã§è¨˜éŒ²</button>
          <button onclick="getRakutenRecipe('${ingredient}')">åˆ¥ã®ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆ</button>
        </div>
      `;
    } catch (error) {
      resultDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error;
    }
  }

  // âœ… ä¿å­˜
  async function saveRecipe() {
    if (!currentRecipe) return;
    const comment = document.getElementById("recipeComment").value.trim();
    const rating = document.getElementById("recipeRating").value;
    await addDoc(collection(db, "recipes"), { ...currentRecipe, comment, rating });
    alert("ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    showSavedRecipes();
  }

  // âœ… ä¿å­˜æ¸ˆã¿ãƒ¬ã‚·ãƒ”ä¸€è¦§
  async function showSavedRecipes() {
    const q = query(collection(db, "recipes"), orderBy("date", "desc"));
    const snapshot = await getDocs(q);
    const list = document.getElementById("savedRecipes");
    list.innerHTML = "";
    snapshot.forEach(doc => {
      const r = doc.data();
      const div = document.createElement("div");
      div.className = "recipe-card";
      div.innerHTML = `
        <h4>${r.name}</h4>
        <img src="${r.image}">
        <p><a href="${r.url}" target="_blank">ãƒ¬ã‚·ãƒ”ã‚’è¦‹ã‚‹</a></p>
        <p><b>æ„Ÿæƒ³:</b> ${r.comment || "ï¼ˆæœªè¨˜å…¥ï¼‰"}</p>
        <p><b>è©•ä¾¡:</b> ${"â­ï¸".repeat(r.rating || 0)}</p>
      `;
      list.appendChild(div);
    });
  }

  // âœ… èµ·å‹•æ™‚å‡¦ç†
  window.onload = showSavedRecipes;
  window.getRakutenRecipe = getRakutenRecipe;
  window.saveRecipe = saveRecipe;
</script>

</head>

<body>
  <h1>ä¸€å“ææ¡ˆå‹ãƒ¬ã‚·ãƒ”è¨˜éŒ²ã‚¢ãƒ—ãƒª ğŸ³</h1>

  <h2>é£Ÿæã‚’å…¥åŠ›</h2>
  <input type="text" id="ingredientInput" placeholder="ä¾‹ï¼šã˜ã‚ƒãŒã„ã‚‚ã€é¶è‚‰ãªã©">
  <button onclick="getRakutenRecipe(document.getElementById('ingredientInput').value.trim())">ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆ</button>

  <h2>ãƒ¬ã‚·ãƒ”ææ¡ˆ</h2>
  <div id="recipeResult"></div>

  <h2>æ–™ç†ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ–ãƒƒã‚¯</h2>
  <div id="savedRecipes"></div>
</body>
</html>
